# Strata

文件系统正在从下面和从上面被强调。在文件系统之下，存储设备的市场基于性能和容量之间的权衡而分散，因此许多系统都配置了本地固态驱动器（SSD）和传统硬盘驱动器（HDD）。非易失性RAM（NVM）将很快增加另一款具有第三种不同容量和性能机制的设备。

动机（解决什么问题）

我们介绍了Strata，一个跨媒体文件系统，它利用一个存储媒体的优势来弥补另一个存储媒体的弱点。在此过程中，Strata同时提供了性能、容量和一个简单的同步IO模型，同时比受单个存储设备约束的文件系统的设计更简单。**Strata的核心采用了一种日志结构的方法**，在用户模式、内核和存储层之间进行新的职责划分，将可扩展、高性能持久性的问题与存储层管理区分开来。我们使用模拟NVM的3层存储层次结构、基于闪存的SSD和高密度HDD来量化Strata的性能优势。与专门为每个层构建的文件系统相比，分层具有提高20-30%的延迟和吞吐量，同时提供对整个存储层次结构的同步和统一访问。最后，与由Linux的逻辑卷管理器提供的基于块的2层缓存相比，Strata实现了高达2.8×的更好的吞吐量。

## 主要设计点

事务日志： 提交记录包含一个唯一的、单调递增的层事务号和一个报头内容的校验和。当Strata事务提交时，LibFS通过使用比较和交换操作原子分配日志空间，首先编写头和数据，等待持久性，然后持久化提交记录，来确保原子性和隔离。日志头包含一个指向下一个日志头的指针，因此可以很容易地重播日志。（标记位的方式，需要两次flush+fence）

## 优点（借鉴点）

在NVM层下面，所有设备写都是顺序的，并对设备选择的**大块边界对齐**，例如ssd的擦除块和带状磁盘的写区。（减少SSD内部的垃圾回收造成的写放大）

做了小写（小于4KB）的优化，直接按照log写入NVM，减少写放大。当KernelFS消化日志时，一个小写被按顺序写入日志并转换为块写，最大限度地提高IO吞吐量并消除写放大。

淘汰page cache，实现零拷贝。每次都是同步写到NVM。

## 缺点

Strata采用类似LSM-tree的方式管理数据，后台的digest消化过程可能会浪费很多NVM宝贵的带块。

没有考虑到SSD和NVM的并行带宽。Ziggurat考虑到了。

没有考虑**log的个数**对性能的影响。

LibFS在DRAM中缓存数据和元数据。但是，数据只有在从SSD或HDD读取时才会被缓存。NVM不需要高速缓存。
