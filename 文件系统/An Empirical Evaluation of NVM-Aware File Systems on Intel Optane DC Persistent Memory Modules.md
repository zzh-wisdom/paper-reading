# An Empirical Evaluation of NVM-Aware File Systems on Intel Optane DC Persistent Memory Modules

非易失性存储器（NVM）的出现给数据管理系统的设计带来了新的机遇和挑战。作为数据管理系统的重要组成部分，开发了一些利用NVM特性的新的文件系统。然而，**这些具有nvm感知的文件系统通常是基于模拟或仿真来设计和评估的。为了探索这些文件系统在实际硬件上的性能和特性，在本文中，我们提供了对第一个商用可用的字节可寻址NVM（即Intel Optane DC持久内存模块（DCPMM））上的NVM感知文件系统的实证评估**。首先，为了比较传统文件系统和nvm感知文件系统之间的性能差异，我们评估了Ext4、XFS、F2FS、Ext4-DAX、XFS-DAX和NOVA文件系统在DCPMM上的性能。为了将dcpmm与其他二级存储设备进行比较，我们还对Optane ssd和nand闪存ssd进行了相同的评估。其次，我们观察了远程NUMA节点访问和设备映射器条带如何影响dcpmm的性能。最后，我们评估了在使用Ext4和Ext4-DAX文件系统的dcpmm上的数据库（即MySQL）的性能。我们从评估结果和性能分析中总结了一些观察结果。我们预计，这些观察结果将为各种内存和存储系统提供影响。

## Introduction

新兴的非易失性存储器（NVM）技术，如自旋转矩传输存储器[1]、相变存储器[2]、电阻式存储器[3]，以及英特尔和美光的3D XPoint技术[4]，有望彻底改变I/O性能。NVM提供了DRAM [5,6]一个数量级的持久性，并在DRAM和传统辅助存储设备之间的存储层次结构中创建了一个新的级别。

随着新硬件和平台的出现，总是导致人们重新考虑如何设计数据管理系统，NVM的出现给系统设计带来了新的机遇和新的挑战。文件系统作为数据管理系统的重要组成部分，是NVM应用研究的热点。许多研究人员已经设计并开发了新的NVM感知文件系统，可以更好地利用NVM特性，如BPFS [7]、PMFS [8]和NOVA [9,10]。**然而，由于以往研究的设计和评估通常是基于模拟和仿真，它们在真实的NVM设备上工作的确切性能是未知的。最近，第一个可字节寻址的NVM产品，Intel Optane DC持久性内存模块（DCPMM）[11]，已经上市**。对真实硬件的评估可以使其更准确评估具有nvm感知的文件系统对应用程序的影响，并为未来的系统设计提供提示。

在本文中，为了了解NVM设备上NVM感知文件系统和传统文件系统之间的性能差异，我们评估了Intel Optane DCPMM上不同工作负载下NVM感知文件系统和传统文件系统的性能。因为新设备并不总是保证在所有情况下更好的结果，为了帮助研究人员和系统设计者做出更好的选择使用哪个存储设备在设计未来的系统时，我们也评估这些文件系统的性能在英特尔Optane SSDs [12]和NVMe SSDs来比较不同存储设备下每个文件系统的性能差异和特点。从评估结果中，我们得到了以下观察结果，这些结果可能对未来的系统设计有用： (1)直接访问对文件系统写性能有显著的改进，但对读取性能的影响较小。(2)**并发写访问会降低dcpmm的性能，而并发读访问则不会**。(3)从远程套接字访问降低了dcpmm的写性能，但对读取性能影响不大。(4)为了充分利用dcpmm的管理性能，需要重新设计低开销的文件系统元数据管理策略。(5)将来自不同套接字的dcpmm作为一个逻辑设备组织起来，也可以实现设备的全部性能。(6) DCPMM能够更好地显示其对小规模请求的优势。(7)即使使用相同的系统api，我们也需要考虑它们在不同硬件平台下对正常块设备和NVM设备的不同影响。

本文是我们之前的工作[13]的扩展版本。在之前的工作中，我们通过文件系统基准测试（例如FIO [14]和文件台[15]）评估和分析了dcpmm上文件系统的性能。在本文中，我们评估和分析了数据库在不同配置的dcpmm上的性能。此外，我们还对每个评估的结果进行了更详细的分析。

## 背景及相关工作

本文主要研究了DCPMm上传统和nvm感知文件系统的性能特性，并将DCPMm与其他辅助存储设备进行了比较，从而为未来存储系统的设计提供了帮助。在本节中，我们首先简要介绍英特尔Optane DCPMM的特性。接下来，我们将解释nvm感知文件系统和传统文件系统之间的相似性和异同。最后，我们讨论了相关的工作。

### Intel Optane DC Persistent Memory Modules

Intel Optane DCPMM是第一个基于3D XPoint技术[4]的商用字节可寻址的NVM产品。DCPmm通过集成内存控制器（iMC）和DDR-T协议[16]连接到CPU。iMC为每个DCPMM维护读取和写挂起队列。DDR-T使用一个72位的数据总线，并在一个高速缓存线单元（64字节）中交换数据。因此，CPU可以跳过页面缓存，并直接在DCPMM上执行内存I/O操作。**DCPMM内部的基本访问单元为256字节；因此，任何小于256字节的写请求都成为一个读-修改-写操作，增加了写放大。为了减少由两种不同的访问粒度引起的写放大，dcpmm有一个较小的内部写合并缓冲区，用于合并相邻的写操作**。为了确保持久性，DCPMM的写入挂起队列和内部写入缓冲区被放入Intel的异步DRAM刷新（ADR）域中，以确保到达写入待定队列的CPU存储将在电源故障[17]中存活下来。

DCPMM可以用作内存或用作持久存储，这取决于其设置为工作[11]的操作模式。

内存模式：在这种模式下，dcpmm和DRAM被融合到一个易失性存储空间中。由于DRAM优于DCPMM，DRAM被用作DCPMM的直接映射回写缓存。需要注意的是，即使是存储介质DCPMM是非易失性的，为了数据安全，DCPMM中的数据在内存模式下的功率周期之间被有意地加密擦除。

应用程序直接模式：在这种模式下，dcpmm作为永久存储设备暴露给系统。**同一CPU套接字上的dCPmm可以分组为一个交错组。交错组在硬件级别上类似于RAID-0设备，它通过数据条带来增加带宽**。在本文中，由于我们关注的是文件系统如何在dcpmm上工作，因此我们将DCPMMs配置为App Direct模式。

英特尔有另一款使用3D XPoint作为存储媒体的产品：英特尔Optane SSD。与dcpmm不同，Optane SSD是通过PCIe和NVMe接口连接到机器的，因此它不能用作内存。它更像是一个NAND-flash SSD，但延迟更低，而且没有垃圾收集。

### NVM-Aware文件系统

先前的研究已经证明，传统的文件系统并不能提供低延迟存储设备[18–20]的完整性能。为了更好地利用NVM设备的低延迟、高带宽和字节可寻址特性，开发了一些具有NVM感知的文件系统，如XFS-DAX [21]、Ext4-DAX [22]、BPFS [7]、PMFS [8]和NOVA [9]。

nvm感知的文件系统通常使用一种称为直接访问（DAX）[23]的技术来绕过操作系统的页面缓存和I/O堆栈，从而减少了软件造成的开销和延迟。DAX使应用程序能够将具有nvm感知的文件系统上的文件映射到它们的地址空间中，因此应用程序可以通过内存加载和存储指令直接访问数据。相比之下，传统的文件系统不支持DAX。此外，一些传统的文件系统被设计为依赖于由存储设备提供的扇区写入原子性。为了支持这些文件系统，dcpmm需要维护一个名为块转换表（BTT）的额外软件层，以保证原子扇区更新[24]。维护BTT的开销进一步扩大了传统文件系统和感知nvm的文件系统之间的性能差距。

XFS-DAX和Ext4-DAX是XFS和Ext4的NVM感知支持版本，它们支持直接访问。BPFS是一个nvm感知的文件系统，它使用阴影分页技术来减少写放大和数据复制。PMFS为文件系统元数据提供一致和持久的更新，并通过mmap接口支持DAX到应用程序。NOVA采用了日志结构化文件系统的技术，为每个inode提供了一个单独的日志，从而在确保强一致性的同时提供了高性能。

### 相关工作


